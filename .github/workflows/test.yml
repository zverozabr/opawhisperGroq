name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y alsa-utils xclip xdotool libgtk-3-0 xvfb

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run tests
        run: |
          uv sync --frozen
          xvfb-run -a uv run pytest -v --ignore=tests/test_playwright_e2e.py --ignore=tests/test_gui_e2e.py --ignore=tests/test_hotkey_e2e.py --ignore=tests/test_transcription_e2e.py

  test-windows:
    runs-on: windows-latest
    continue-on-error: true  # Windows support is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Install ffmpeg
        run: choco install ffmpeg -y

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run tests
        run: |
          uv sync --frozen
          uv run pytest -v --ignore=tests/test_playwright_e2e.py --ignore=tests/test_gui_e2e.py --ignore=tests/test_hotkey_e2e.py --ignore=tests/test_transcription_e2e.py
        shell: pwsh

  test-macos:
    runs-on: macos-latest
    continue-on-error: true  # macOS support is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Install sox
        run: brew install sox

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run tests
        run: |
          uv sync --frozen
          uv run pytest -v --ignore=tests/test_playwright_e2e.py --ignore=tests/test_gui_e2e.py --ignore=tests/test_hotkey_e2e.py --ignore=tests/test_transcription_e2e.py

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install ruff
        run: uv tool install ruff

      - name: Lint
        run: ruff check src/ tests/
